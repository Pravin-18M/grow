<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grwo | Deep Analytics Engine</title>
    
    <!-- External Resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ----------------------------------------------------------------
           LUXURY ANALYTICS THEME
        ---------------------------------------------------------------- */
        :root {
            --primary: #1a1a1a;
            --gold: #d4af37;
            --bg: #f8f9fa;
            --glass: #ffffff;
            --border: rgba(0,0,0,0.05);
            --shadow-soft: 0 10px 40px rgba(0,0,0,0.03);
            --transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0; overflow-x: hidden;
        }

        .brand-font { font-family: 'Playfair Display', serif; }
        .text-gold { color: var(--gold) !important; }
        .bg-gold { background-color: var(--gold) !important; }

        /* SIDEBAR */
        .sidebar {
            width: 280px; background: #fff; border-right: 1px solid #eee;
            padding: 30px; position: fixed; height: 100vh; z-index: 100;
            display: flex; flex-direction: column;
        }
        .nav-link {
            color: #666; font-weight: 500; padding: 12px 20px;
            border-radius: 12px; margin-bottom: 5px; display: flex; align-items: center; gap: 12px;
            transition: var(--transition); text-decoration: none;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .nav-link.active i { color: var(--gold); }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px; width: calc(100% - 280px); padding: 40px; min-height: 100vh;
        }

        /* KPI CARDS */
        .kpi-card {
            background: #fff; border-radius: 20px; padding: 30px;
            border: 1px solid var(--border); box-shadow: var(--shadow-soft);
            position: relative; overflow: hidden; transition: var(--transition);
        }
        .kpi-card:hover { transform: translateY(-5px); box-shadow: 0 20px 50px rgba(0,0,0,0.08); }
        
        .kpi-icon {
            position: absolute; top: 20px; right: 10px; font-size: 2.5rem; opacity: 0.1; color: var(--primary);
        }
        .kpi-value { font-size: 2.5rem; font-weight: 700; margin: 10px 0; font-family: 'Playfair Display'; color: var(--primary); }
        .kpi-label { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #888; }
        .kpi-trend { font-size: 0.85rem; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .text-success { color: #059669 !important; }

        /* CHART PANELS */
        .chart-panel {
            background: #fff; border-radius: 24px; padding: 30px;
            border: 1px solid var(--border); box-shadow: var(--shadow-soft);
            position: relative; overflow: visible;
        }
        canvas { max-width:100%; display:block; }
        .skeleton-bar { height:25px; border-radius:12px; background: linear-gradient(90deg,#eee,#f8f8f8,#eee); background-size:200% 100%; animation: shimmer 1.1s linear infinite; }
        @keyframes shimmer { 0% { background-position:200% 0 } 100% { background-position:-200% 0 } }

        /* METRIC BARS */
        .metric-row { margin-bottom: 20px; }
        .metric-header { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 0.9rem; font-weight: 600; }
        .progress { height: 8px; border-radius: 10px; background-color: #f0f0f0; }
        .progress-bar { background-color: var(--primary); border-radius: 10px; }

        .btn-action {
            background: #fff; border: 1px solid #eee; padding: 10px 20px; border-radius: 30px;
            font-weight: 600; font-size: 0.9rem; transition: 0.3s;
        }
        .btn-action:hover { background: var(--primary); color: #fff; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar d-flex flex-column">
        <a href="dashboard.html" class="d-flex align-items-center mb-4 text-decoration-none text-dark">
            <span class="fs-3 fw-bold brand-font">Grwo<span class="text-gold">.</span></span>
        </a>
        <ul class="nav nav-pills flex-column mb-auto">
            <li><a href="dashboard.html" class="nav-link"><i class="fa-solid fa-gauge-high"></i> Dashboard</a></li>
            <li><a href="properties.html" class="nav-link"><i class="fa-solid fa-building"></i> Properties</a></li>
            <li><a href="customers.html" class="nav-link"><i class="fa-solid fa-users"></i> Customers</a></li>
            <li><a href="calender_tasks.html" class="nav-link"><i class="fa-regular fa-calendar-check"></i> Calendar</a></li>
            <li><a href="reach.html" class="nav-link"><i class="fa-solid fa-paper-plane"></i> Reach</a></li>
            <li><a href="customerdirectory.html" class="nav-link"><i class="fa-solid fa-address-book"></i> Customer Directory</a></li>
            <li><a href="analytics.html" class="nav-link active"><i class="fa-solid fa-chart-line"></i> Analytics</a></li>
            <li><a href="grwoai.html" class="nav-link"><i class="fa-solid fa-brain"></i> GrwoAI</a></li>
            <li><a href="index.html" class="nav-link mt-5 text-danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
        <div class="mt-auto">
            <div class="p-3 bg-light rounded-4 border text-center">
                <small class="text-muted d-block text-uppercase" style="font-size:0.7rem;">Logged in as</small>
                <strong class="text-gold" id="sidebarUserFirm">User <span class="text-dark">|</span> Firm</strong>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
                <script>
                    // Update sidebar with real user and firm name from localStorage
                    document.addEventListener('DOMContentLoaded', function() {
                        const sidebarUserFirm = document.getElementById('sidebarUserFirm');
                        let user = null;
                        try { user = JSON.parse(localStorage.getItem('user')); } catch {}
                        if (user && user.firmName) {
                            const nameToShow = user.fullName || user.email || 'User';
                            sidebarUserFirm.innerHTML = `${nameToShow} <span class="text-dark">|</span> ${user.firmName}`;
                        } else {
                            sidebarUserFirm.innerHTML = 'User <span class="text-dark">|</span> Firm';
                        }
                    });
                </script>
        
        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-end mb-5">
            <div>
                <h6 class="text-gold text-uppercase letter-spacing-2 mb-1">Business Intelligence</h6>
                <h2 class="brand-font display-6 fw-bold">Performance Analysis</h2>
            </div>
            <div class="d-flex gap-2">
                <select class="form-select bg-white border-0 shadow-sm rounded-pill px-4" style="width: 150px;">
                    <option>This Month</option>
                    <option>Last Quarter</option>
                    <option>This Year</option>
                </select>
                <button class="btn btn-dark rounded-pill px-4" onclick="downloadReport()">
                    <i class="fa-solid fa-download me-2"></i> Export Report
                </button>
            </div>
        </div>

        <!-- KPI ROW -->
        <div class="row g-4 mb-5">
            <!-- Revenue -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <i class="fa-solid fa-indian-rupee-sign kpi-icon"></i>
                    <div class="kpi-label">Total Revenue Generated</div>
                    <div class="kpi-value" data-target="245000000">0</div>
                    <div class="kpi-trend" id="trend-revenue"></div>
                </div>
            </div>
            <!-- Sales Count -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <i class="fa-solid fa-handshake-simple kpi-icon"></i>
                    <div class="kpi-label">Deals Closed (Sales)</div>
                    <div class="kpi-value" data-target="18">0</div>
                    <div class="kpi-trend" id="trend-deals"></div>
                </div>
            </div>
            <!-- Site Visits -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <i class="fa-solid fa-car kpi-icon"></i>
                    <div class="kpi-label">Site Visits Completed</div>
                    <div class="kpi-value" data-target="142">0</div>
                    <div class="kpi-trend" id="trend-visits"></div>
                </div>
            </div>
            <!-- Enquiries -->
            <div class="col-md-3">
                <div class="kpi-card">
                    <i class="fa-solid fa-users-rays kpi-icon"></i>
                    <div class="kpi-label">New Enquiries</div>
                    <div class="kpi-value" data-target="345">0</div>
                    <div class="kpi-trend" id="trend-enquiries"></div>
                </div>
            </div>
        </div>

        <!-- MAIN CHART & CALLS -->
        <div class="row g-4 mb-5">
            <div class="col-lg-8">
                <div class="chart-panel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="brand-font mb-0">Revenue vs Target</h4>
                        <span class="badge bg-light text-dark border">Financials</span>
                    </div>
                    <canvas id="revenueChart" style="height: 350px; width: 100%;"></canvas>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="chart-panel">
                    <h4 class="brand-font mb-4">Call Intelligence</h4>
                    <div id="calls-loading" class="text-center text-muted small">Loading calls...</div>
                    <div id="calls-panel" class="d-none">
                        <div class="text-center mb-4">
                            <div class="display-4 fw-bold brand-font" id="total-calls">0</div>
                            <small class="text-muted text-uppercase">Total Calls Made</small>
                        </div>
                        <div class="metric-row">
                            <div class="metric-header"><span>Connected</span> <span id="pct-connected">0%</span></div>
                            <div class="progress"><div class="progress-bar bg-success" id="bar-connected" style="width:0%"></div></div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-header"><span>Not Answered</span> <span id="pct-notanswered">0%</span></div>
                            <div class="progress"><div class="progress-bar bg-warning" id="bar-notanswered" style="width:0%"></div></div>
                        </div>
                        <div class="metric-row">
                            <div class="metric-header"><span>Wrong Number</span> <span id="pct-wrong">0%</span></div>
                            <div class="progress"><div class="progress-bar bg-danger" id="bar-wrong" style="width:0%"></div></div>
                        </div>
                        <div class="mt-4 pt-3 border-top">
                            <div class="d-flex justify-content-between">
                                <small class="text-muted">Avg Duration</small>
                                <strong id="avg-duration">N/A</strong>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">Top Agent</small>
                                <strong id="top-agent">N/A</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LOWER SECTION: FUNNEL & SOURCES -->
        <div class="row g-4">
            <div class="col-lg-6">
                <div class="chart-panel">
                    <h4 class="brand-font mb-4">Conversion Funnel</h4>
                    <div id="funnel-skeleton">
                        <div class='skeleton-bar mb-3 w-100'></div>
                        <div class='skeleton-bar mb-3 w-100'></div>
                        <div class='skeleton-bar mb-3 w-100'></div>
                        <div class='skeleton-bar mb-3 w-100'></div>
                        <div class='skeleton-bar mb-3 w-100'></div>
                    </div>
                    <div id="funnel-container" class="d-none"></div>
                </div>
            </div>
            <div class="col-lg-6">
                <div class="chart-panel d-flex flex-column">
                    <h4 class="brand-font mb-4">Lead Sources</h4>
                    <div class="flex-grow-1 d-flex justify-content-center align-items-center">
                        <canvas id="sourceChart" style="max-height: 250px;"></canvas>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- HELPER: CURRENCY ---
        const formatINR = (val) => {
            if (val >= 10000000) return `₹${(val / 10000000).toFixed(1)} Cr`;
            return `₹${(val / 1000).toFixed(0)}k`;
        };

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            showGlobalLoader(true);
            loadAnalytics().finally(()=> {
                showGlobalLoader(false);
                animateEntrance();
            });
        });

        // --- ANIMATIONS ---
        function animateEntrance() {
            gsap.killTweensOf([".kpi-card", ".chart-panel"]);
            gsap.set([".kpi-card", ".chart-panel"], { clearProps:"opacity,transform" });
            gsap.fromTo(".kpi-card", { opacity:0, y:30 }, { opacity:1, y:0, duration:0.6, stagger:0.08, ease:"power2.out" });
            gsap.fromTo(".chart-panel", { opacity:0, y:30 }, { opacity:1, y:0, duration:0.55, delay:0.1, stagger:0.08, ease:"power2.out" });
        }

        function animateKPI(el, target, isCurrency=false){
            gsap.to(el, {
                innerText: target,
                duration: 1.2,
                snap: { innerText: 1 },
                ease: 'power2.out',
                onUpdate: function(){
                    const val = Math.ceil(this.targets()[0].innerText);
                    el.innerText = isCurrency ? formatINR(val) : val;
                }
            });
        }

        // --- DATA LOADING & CHARTING ---
        function showGlobalLoader(show){
            let el = document.getElementById('global-loader');
            if(!el){
                el = document.createElement('div');
                el.id='global-loader';
                el.innerHTML = `<div class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background:rgba(255,255,255,0.7);z-index:2000"><div class='spinner-border text-gold' role='status'></div></div>`;
                document.body.appendChild(el);
            }
            el.style.display = show? 'block':'none';
        }

        async function loadAnalytics(){
            try {
                const [custRes, propRes, taskRes] = await Promise.all([
                    fetch('/api/customers'),
                    fetch('/api/properties'),
                    fetch('/api/tasks')
                ]);
                const customers = await custRes.json();
                const properties = await propRes.json();
                const taskJson = await taskRes.json();
                const tasks = taskJson.success ? taskJson.data : [];

                // KPI: Revenue
                const closedProps = properties.filter(p => p.closedDate);
                const linkedProps = properties.filter(p => p.customerCustId);
                const sumPrices = arr => arr.reduce((s,p)=> s + (Number(p.price)||0), 0);
                let revenue = sumPrices(closedProps);
                if(revenue === 0) revenue = sumPrices(linkedProps);
                if(revenue === 0) revenue = sumPrices(properties);

                // KPI: Deals closed (customers)
                const dealsClosed = customers.filter(c => c.status === 'Closed').length;

                // KPI: Site visits completed (past or today)
                const now = new Date();
                const siteVisits = tasks.filter(t => t.type === 'Site Visit' && new Date(t.date) <= now).length;

                // KPI: New enquiries (last 30 days)
                const daysAgo30 = new Date(Date.now() - 30*24*60*60*1000);
                const newEnquiries = customers.filter(c => c.createdAt && new Date(c.createdAt) >= daysAgo30).length;

                const [revEl, salesEl, visitsEl, enqEl] = document.querySelectorAll('.kpi-value');
                animateKPI(revEl, revenue, true);
                animateKPI(salesEl, dealsClosed, false);
                animateKPI(visitsEl, siteVisits, false);
                animateKPI(enqEl, newEnquiries, false);

                // Trends
                computeAndRenderTrends({ properties, revenue, dealsClosed, siteVisits, newEnquiries, customers, tasks });

                // Revenue chart (last 6 months)
                const byMonth = aggregateMonthlyRevenue(closedProps.length? closedProps : (linkedProps.length? linkedProps : properties));
                buildRevenueChart(byMonth.labels, byMonth.values);

                // Lead sources chart -> use dealType distribution
                const sourceAgg = aggregateByKey(customers, 'dealType');
                buildSourcesChart(sourceAgg.labels, sourceAgg.values);

                // Call Intelligence: derive from notes
                const allNotes = customers.flatMap(c => c.notes || []);
                const calls = allNotes.filter(n => n.type === 'call');
                renderCallIntelligence(calls);

                // Conversion funnel
                const enquiries = customers.length;
                const qualified = customers.filter(c => c.status === 'Interested').length;
                const negotiations = allNotes.filter(n => n.type === 'meeting').length;
                const sales = dealsClosed;
                updateFunnel({ enquiries, qualified, siteVisits, negotiations, sales });
            } catch (e){
                console.error('Analytics load error', e);
                const errBox = document.createElement('div');
                errBox.className='alert alert-danger mt-3';
                errBox.textContent='Failed loading analytics: '+ e.message;
                document.querySelector('.main-content')?.prepend(errBox);
            }
        }

        function computeAndRenderTrends({ properties, revenue, dealsClosed, siteVisits, newEnquiries, customers, tasks }){
            // Revenue trend: current month vs previous month
            const now = new Date();
            const monthKey = (d)=> d.getFullYear()+ '-' + (d.getMonth()+1);
            let currRev=0, prevRev=0;
            properties.forEach(p => {
                const dt = new Date(p.closedDate || p.createdAt);
                const val = Number(p.price)||0;
                if(monthKey(dt) === monthKey(now)) currRev += val;
                const prev = new Date(now.getFullYear(), now.getMonth()-1, 1);
                if(monthKey(dt) === monthKey(prev)) prevRev += val;
            });
            const revTrendPct = prevRev? ((currRev - prevRev)/prevRev)*100 : 100;
            setTrend('trend-revenue', revTrendPct, 'vs last month');

            // Deals trend: last 7 days vs previous 7 days
            const today = new Date();
            const d7 = new Date(Date.now()-7*864e5);
            const d14 = new Date(Date.now()-14*864e5);
            const recentClosed = customers.filter(c => c.status==='Closed' && c.updatedAt && new Date(c.updatedAt)>=d7).length;
            const prevClosed = customers.filter(c => c.status==='Closed' && c.updatedAt && new Date(c.updatedAt)>=d14 && new Date(c.updatedAt)<d7).length;
            const dealTrendPct = prevClosed? ((recentClosed - prevClosed)/prevClosed)*100 : 100;
            setTrend('trend-deals', dealTrendPct, `${recentClosed} this week`);

            // Site visit attendance: past visits / total scheduled
            const siteVisitTasks = tasks.filter(t => t.type==='Site Visit');
            const pastVisits = siteVisitTasks.filter(t => new Date(t.date) <= today).length;
            const attendance = siteVisitTasks.length? (pastVisits/siteVisitTasks.length)*100 : 0;
            setTrend('trend-visits', attendance, 'Attendance');

            // Enquiries trend: last 7 days vs previous 7 days
            const recentEnq = customers.filter(c => c.createdAt && new Date(c.createdAt)>=d7).length;
            const prevEnq = customers.filter(c => c.createdAt && new Date(c.createdAt)>=d14 && new Date(c.createdAt)<d7).length;
            const enqTrendPct = prevEnq? ((recentEnq - prevEnq)/prevEnq)*100 : 100;
            setTrend('trend-enquiries', enqTrendPct, 'vs prev 7d');
        }

        function setTrend(id, pct, suffix){
            const el = document.getElementById(id);
            if(!el) return;
            const dirIcon = pct>5? 'fa-arrow-trend-up': (pct<-5? 'fa-arrow-trend-down':'fa-minus');
            const cls = pct>5? 'text-success': (pct<-5? 'text-danger':'text-muted');
            el.className = `kpi-trend ${cls}`;
            el.innerHTML = `<i class='fa-solid ${dirIcon}'></i> ${Math.round(pct)}% ${suffix}`;
        }

        function renderCallIntelligence(calls){
            const loading = document.getElementById('calls-loading');
            const panel = document.getElementById('calls-panel');
            if(loading) loading.classList.add('d-none');
            if(panel) panel.classList.remove('d-none');
            const total = calls.length;
            const connected = calls.filter(c => c.followUpDate).length;
            const notAnswered = Math.max(0, total - connected);
            const wrong = 0; // Unknown classification
            document.getElementById('total-calls').textContent = total;
            updateBar('connected', connected, total);
            updateBar('notanswered', notAnswered, total);
            updateBar('wrong', wrong, total);
            // Duration parsing
            const durations = calls.map(c => {
                const m = /(?:duration|dur)[:\s-]*((\d+)m)?\s*(\d+)s/i.exec(c.text||'');
                if(m){
                    const mins = Number(m[2]||0);
                    const secs = Number(m[3]||0);
                    return mins*60 + secs;
                }
                return null;
            }).filter(Boolean);
            const avg = durations.length? durations.reduce((a,b)=>a+b,0)/durations.length : null;
            const avgLabel = avg? `${Math.floor(avg/60)}m ${(avg%60).toFixed(0)}s` : 'N/A';
            document.getElementById('avg-duration').textContent = avgLabel;
            // Top agent inference (search for 'agent: Name' pattern)
            const agentCount = {};
            calls.forEach(c => {
                const m = /agent[:\s-]*([A-Za-z ]{2,40})/i.exec(c.text||'');
                if(m){ const name = m[1].trim(); agentCount[name] = (agentCount[name]||0)+1; }
            });
            const topAgent = Object.entries(agentCount).sort((a,b)=>b[1]-a[1])[0]?.[0] || 'N/A';
            document.getElementById('top-agent').textContent = topAgent;
        }

        function updateBar(key, part, total){
            const pctVal = total? (part/total)*100 : 0;
            const pctRounded = Math.round(pctVal);
            const bar = document.getElementById(`bar-${key}`);
            const label = document.getElementById(`pct-${key}`);
            if(bar) bar.style.width = pctRounded + '%';
            if(label) label.textContent = pctRounded + '%';
        }

        function aggregateMonthlyRevenue(props){
            // Build last 6 months buckets
            const labels = [];
            const values = [];
            const map = new Map();
            for(let i=5;i>=0;i--){
                const d = new Date();
                d.setMonth(d.getMonth()-i);
                const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
                const label = d.toLocaleString('en-US',{ month:'short' });
                labels.push(label);
                map.set(key, 0);
            }
            props.forEach(p => {
                const date = p.closedDate || p.createdAt;
                if(!date) return;
                const d = new Date(date);
                const key = d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0');
                if(map.has(key)) map.set(key, map.get(key) + (Number(p.price)||0));
            });
            const vals = Array.from(map.values()).slice(-6).map(v => +(v/10000000).toFixed(2)); // to Crores
            return { labels, values: vals };
        }

        function aggregateByKey(items, key){
            const counts = new Map();
            items.forEach(it => {
                const k = it[key] || 'Unknown';
                counts.set(k, (counts.get(k)||0)+1);
            });
            return { labels: Array.from(counts.keys()), values: Array.from(counts.values()) };
        }

        function buildRevenueChart(labels, values){
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(212, 175, 55, 0.5)');
            gradient.addColorStop(1, 'rgba(212, 175, 55, 0.0)');
            new Chart(ctx, {
                type: 'line',
                data: { labels, datasets: [{ label: 'Revenue (Cr)', data: values, borderColor:'#d4af37', backgroundColor: gradient, fill:true, tension:0.4, pointBackgroundColor:'#1a1a1a', pointBorderColor:'#d4af37', pointRadius:5 }]},
                options: { responsive:true, maintainAspectRatio:true, plugins:{ legend:{ display:false }}, scales:{ y:{ beginAtZero:true, grid:{ borderDash:[5,5]} }, x:{ grid:{ display:false } } } }
            });
        }

        function buildSourcesChart(labels, values){
            const ctx = document.getElementById('sourceChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels, datasets:[{ data: values, backgroundColor: ['#1a1a1a','#d4af37','#999999','#e0e0e0','#6366f1','#22c55e','#f97316','#ef4444'], borderWidth:0 }]},
                options: { responsive:true, plugins:{ legend:{ position:'bottom', labels:{ usePointStyle:true, padding:20 } } }, cutout:'70%' }
            });
        }

        function setBarPct(rowEl, pct){
            if(!rowEl) return;
            const bar = rowEl.querySelector('.progress-bar');
            const label = rowEl.querySelector('.metric-header span:last-child');
            const p = isFinite(pct) ? Math.max(0, Math.min(100, Math.round(pct))) : 0;
            if(bar) bar.style.width = p + '%';
            if(label) label.textContent = p + '%';
        }

        function pct(part, total){ return total>0 ? (part/total)*100 : 0; }

        function updateFunnel({ enquiries, qualified, siteVisits, negotiations, sales }){
            const total = Math.max(enquiries, 1);
            const rows = [
                { key:'Enquiries', value: enquiries, color:'bg-dark' },
                { key:'Qualified', value: qualified, color:'bg-secondary' },
                { key:'Site Visits', value: siteVisits, color:'bg-gold' },
                { key:'Negotiation', value: negotiations, color:'bg-info' },
                { key:'Sales', value: sales, color:'bg-success' }
            ];
            const skeleton = document.getElementById('funnel-skeleton');
            const container = document.getElementById('funnel-container');
            if(skeleton) skeleton.classList.add('d-none');
            if(container){
                container.classList.remove('d-none');
                container.innerHTML = rows.map(r=>`<div class="d-flex align-items-center mb-3">
                    <div style="width:110px;" class="small fw-bold">${r.key}</div>
                    <div class="progress flex-grow-1" style="height:25px;">
                        <div class="progress-bar ${r.color}" style="width:${Math.round((r.value/total)*100)}%">${r.value}</div>
                    </div>
                </div>`).join('');
            }
        }

        function downloadReport() {
            alert("Preparing PDF report with current analytics view...");
        }

    </script>
</body>
</html>