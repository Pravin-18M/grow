<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Grwo | Schedule Command</title>
    <!-- External Resources -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* ----------------------------------------------------------------
           LUXURY DESIGN SYSTEM
        ---------------------------------------------------------------- */
        :root {
            --primary: #1a1a1a;
            --gold: #d4af37;
            --bg: #f8f9fa;
            --glass: rgba(255, 255, 255, 0.95);
            --border: #eaeaea;
            --transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg);
            color: var(--primary);
            margin: 0; overflow-x: hidden;
        }

        .brand-font { font-family: 'Playfair Display', serif; }
        .text-gold { color: var(--gold) !important; }
        .bg-gold { background-color: var(--gold) !important; }

        /* SIDEBAR */
        .sidebar {
            width: 280px; background: #fff; border-right: 1px solid #eee;
            padding: 30px; position: fixed; height: 100vh; z-index: 100;
            display: flex; flex-direction: column;
        }
        .nav-link {
            color: #666; font-weight: 500; padding: 12px 20px;
            border-radius: 12px; margin-bottom: 5px; display: flex; align-items: center; gap: 12px;
            transition: var(--transition); text-decoration: none;
        }
        .nav-link:hover, .nav-link.active {
            background: var(--primary); color: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .nav-link.active i { color: var(--gold); }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 280px; width: calc(100% - 280px); padding: 40px; min-height: 100vh;
        }

        /* --- CALENDAR ENGINE STYLES --- */
        .calendar-container {
            background: #fff; border-radius: 24px; padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.03); border: 1px solid var(--border);
        }

        .calendar-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;
        }

        .weekdays-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); text-align: center;
            margin-bottom: 15px; font-weight: 600; color: #999; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px;
        }

        .days-grid {
            display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px;
        }

        .calendar-day {
            height: 100px; border-radius: 16px; border: 1px solid transparent;
            background: #fafafa; padding: 10px; position: relative; cursor: pointer;
            transition: var(--transition); display: flex; flex-direction: column; justify-content: flex-start;
        }

        .calendar-day:hover {
            transform: translateY(-3px); background: #fff; border-color: var(--gold);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.1);
        }

        .calendar-day.active {
            background: var(--primary); color: #fff;
        }
        .calendar-day.active .day-number { color: #fff; }
        
        .calendar-day.today { border: 1px solid var(--gold); background: #fffbf0; }

        .day-number { font-weight: 700; font-size: 1.1rem; color: var(--primary); margin-bottom: 5px; }
        
        .event-dot {
            width: 6px; height: 6px; background-color: var(--gold); border-radius: 50%;
            margin-top: auto; align-self: center; margin-bottom: 5px;
        }

        .prev-date { opacity: 0.3; pointer-events: none; }

        /* --- AGENDA PANEL (RIGHT SIDE) --- */
        .agenda-panel {
            background: #fff; border-radius: 24px; padding: 30px; height: 100%;
            border: 1px solid var(--border); border-left: 4px solid var(--gold);
            box-shadow: 0 10px 40px rgba(0,0,0,0.03);
        }

        .timeline-item {
            display: flex; gap: 20px; margin-bottom: 25px; position: relative;
        }
        .timeline-item::before {
            content: ''; position: absolute; left: 7px; top: 35px; bottom: -30px; width: 2px; background: #f0f0f0;
        }
        .timeline-item:last-child::before { display: none; }

        .time-col { width: 80px; text-align: right; font-size: 0.85rem; color: #888; padding-top: 5px; }
        .marker-col { 
            width: 16px; height: 16px; border-radius: 50%; background: #fff; border: 3px solid var(--gold); z-index: 2;
        }
        .content-col { flex: 1; background: #f9f9f9; padding: 15px; border-radius: 12px; transition: var(--transition); cursor: pointer; }
        .content-col:hover { background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.05); transform: translateX(5px); }

        .btn-nav {
            background: #f4f4f4; border: none; width: 40px; height: 40px; border-radius: 50%;
            transition: 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .btn-nav:hover { background: var(--primary); color: #fff; }

        .btn-premium {
            background: var(--primary); color: #fff; border-radius: 50px; padding: 10px 25px; border: none;
        }
        .btn-premium:hover { background: var(--gold); color: #fff; }

    </style>
</head>
<body>

    <!-- SIDEBAR -->
    <div class="sidebar d-flex flex-column">
        <a href="dashboard.html" class="d-flex align-items-center mb-4 text-decoration-none text-dark">
            <span class="fs-3 fw-bold brand-font">Grwo<span class="text-gold">.</span></span>
        </a>
        <ul class="nav nav-pills flex-column mb-auto">
            <li><a href="dashboard.html" class="nav-link"><i class="fa-solid fa-gauge-high"></i> Dashboard</a></li>
            <li><a href="properties.html" class="nav-link"><i class="fa-solid fa-building"></i> Properties</a></li>
            <li><a href="customers.html" class="nav-link"><i class="fa-solid fa-users"></i> Customers</a></li>
            <li><a href="calender_tasks.html" class="nav-link active"><i class="fa-regular fa-calendar-check"></i> Calendar</a></li>
            <li><a href="reach.html" class="nav-link"><i class="fa-solid fa-paper-plane"></i> Reach</a></li>
            <li><a href="customerdirectory.html" class="nav-link"><i class="fa-solid fa-address-book"></i> Customer Directory</a></li>
            <li><a href="analytics.html" class="nav-link"><i class="fa-solid fa-chart-line"></i> Analytics</a></li>
            <li><a href="grwoai.html" class="nav-link"><i class="fa-solid fa-brain"></i> GrwoAI</a></li>
            <li><a href="index.html" class="nav-link mt-5 text-danger"><i class="fa-solid fa-right-from-bracket"></i> Logout</a></li>
        </ul>
        <div class="mt-auto">
            <div class="p-3 bg-light rounded-4 border text-center">
                <small class="text-muted d-block text-uppercase" style="font-size: 0.7rem;">Logged in as</small>
                <strong class="text-gold" id="sidebarUserFirm">User <span class="text-dark">|</span> Firm</strong>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
                <script>
                    // Update sidebar with real user and firm name from localStorage
                    document.addEventListener('DOMContentLoaded', function() {
                        const sidebarUserFirm = document.getElementById('sidebarUserFirm');
                        let user = null;
                        try { user = JSON.parse(localStorage.getItem('user')); } catch {}
                        if (user && user.firmName) {
                            const nameToShow = user.fullName || user.email || 'User';
                            sidebarUserFirm.innerHTML = `${nameToShow} <span class="text-dark">|</span> ${user.firmName}`;
                        } else {
                            sidebarUserFirm.innerHTML = 'User <span class="text-dark">|</span> Firm';
                        }
                    });
                </script>
        
        <!-- HEADER -->
        <div class="d-flex justify-content-between align-items-end mb-4">
            <div>
                <h6 class="text-gold text-uppercase letter-spacing-2 mb-1">Workflow Operations</h6>
                <h2 class="brand-font display-6 fw-bold">Schedule Command</h2>
            </div>
            <button class="btn btn-premium" data-bs-toggle="modal" data-bs-target="#addTaskModal">
                <i class="fa-solid fa-plus me-2"></i> New Task
            </button>
        </div>

        <div class="row g-4">
            <!-- LEFT: CALENDAR GRID -->
            <div class="col-lg-8">
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h3 class="brand-font mb-0" id="monthYear">September 2023</h3>
                        <div class="d-flex gap-2">
                            <button class="btn-nav" onclick="changeMonth(-1)"><i class="fa-solid fa-chevron-left"></i></button>
                            <button class="btn-nav" onclick="changeMonth(1)"><i class="fa-solid fa-chevron-right"></i></button>
                        </div>
                    </div>

                    <div class="weekdays-grid">
                        <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
                    </div>
                    
                    <div class="days-grid" id="calendarDays">
                        <!-- JS Generated Days -->
                    </div>
                </div>
            </div>

            <!-- RIGHT: AGENDA PANEL -->
            <div class="col-lg-4">
                <div class="agenda-panel">
                    <h4 class="brand-font mb-1" id="selectedDateDisplay">Today</h4>
                    <p class="text-muted small mb-4 text-uppercase letter-spacing-1">Scheduled Activities</p>
                    
                    <div id="agenda-content">
                        <!-- JS Generated Tasks -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- ADD TASK MODAL -->
    <div class="modal fade" id="addTaskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content p-3 rounded-4 border-0 shadow-lg">
                <div class="modal-header border-0">
                    <h5 class="modal-title brand-font">Create New Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body pt-0">
                    <form onsubmit="handleAddTask(event)">
                        <div class="mb-3"><input type="text" class="form-control bg-light" name="title" placeholder="Task Title" required></div>
                        <div class="row mb-3">
                            <div class="col"><input type="date" class="form-control bg-light" name="date" required></div>
                            <div class="col"><input type="time" class="form-control bg-light" name="time" required></div>
                        </div>
                        <div class="mb-3">
                            <select class="form-select bg-light" name="type">
                                <option value="Client Meeting">Client Meeting</option>
                                <option value="Site Visit">Site Visit</option>
                                <option value="Internal Review">Internal Review</option>
                                <option value="Call">Call</option>
                                <option value="Follow-Up">Follow-Up</option>
                                <option value="Other" selected>Other</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <textarea class="form-control bg-light" rows="4" name="description" placeholder="Detailed Description / Agenda"></textarea>
                        </div>
                        <button type="submit" class="btn btn-premium w-100">Create Task</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>

    <script>
        // --- STATE MANAGEMENT ---
        let currentDate = new Date();
        let selectedDate = new Date();
        
        // Dynamic data sources
        let tasks = []; // backend tasks
        let followups = []; // customer follow-up notes
        const API_BASE = 'http://localhost:3000/api';
        let customerMap = {}; // custId -> name

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', async () => {
            await loadData();
            renderCalendar();
            renderAgenda(new Date().getDate());
        });

        async function loadData(){
            try {
                // Fetch customers for name lookup
                const custRes = await fetch(`${API_BASE}/customers`);
                const custJson = await custRes.json();
                customerMap = {};
                (custJson || []).forEach(c => { if(c.custId) customerMap[c.custId] = c.name; });
                // Fetch tasks
                const taskRes = await fetch(`${API_BASE}/tasks`);
                const taskJson = await taskRes.json();
                tasks = (taskJson.data || []).map(t => ({
                    _id: t._id,
                    title: t.title,
                    type: t.type,
                    dateObj: new Date(t.date),
                    date: new Date(t.date).getDate(),
                    description: t.description,
                    customerCustId: t.customerCustId
                }));
                // Fetch upcoming followups
                const fuRes = await fetch(`${API_BASE}/customers/followups/upcoming`);
                const fuJson = await fuRes.json();
                followups = (fuJson.data || []).map(f => ({
                    followUpDateObj: new Date(f.followUpDate),
                    date: new Date(f.followUpDate).getDate(),
                    title: f.text,
                    type: 'Follow-Up',
                    customerName: f.customerName,
                    customerCustId: f.customerCustId
                }));
            } catch(e){
                console.error('Calendar data load failed', e);
            }
        }

        // --- CALENDAR ENGINE ---
        function renderCalendar() {
            const monthYear = document.getElementById('monthYear');
            const daysContainer = document.getElementById('calendarDays');
            
            // Set Header
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            monthYear.innerText = `${months[currentDate.getMonth()]} ${currentDate.getFullYear()}`;

            // Grid Math
            daysContainer.innerHTML = "";
            const firstDayIndex = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            
            // Prev Month Padding
            for (let x = firstDayIndex; x > 0; x--) {
                daysContainer.innerHTML += `<div class="calendar-day prev-date"></div>`;
            }

            // Days
            for (let i = 1; i <= lastDay; i++) {
                // Check if any task or follow-up exists this day
                const hasTask = tasks.some(t => t.date === i) || followups.some(f => f.date === i);
                const isToday = i === new Date().getDate() && currentDate.getMonth() === new Date().getMonth();
                const isActive = i === selectedDate.getDate() && currentDate.getMonth() === selectedDate.getMonth();

                let dotHtml = hasTask ? `<div class="event-dot"></div>` : '';
                let classes = `calendar-day ${isToday ? 'today' : ''} ${isActive ? 'active' : ''}`;

                daysContainer.innerHTML += `
                    <div class="${classes}" onclick="selectDay(${i}, this)">
                        <div class="day-number">${i}</div>
                        ${dotHtml}
                    </div>`;
            }
        }

        function changeMonth(direction) {
            currentDate.setMonth(currentDate.getMonth() + direction);
            renderCalendar();
        }

        function selectDay(day, element) {
            // Update UI Selection
            document.querySelectorAll('.calendar-day').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            // Update Logic
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            
            // Animation for Agenda
            gsap.to(".agenda-panel", { opacity: 0.5, duration: 0.1, yoyo: true, repeat: 1 });
            setTimeout(() => {
                renderAgenda(day);
            }, 100);
        }

        // --- AGENDA RENDERER ---
        function renderAgenda(day) {
            const container = document.getElementById('agenda-content');
            const title = document.getElementById('selectedDateDisplay');
            
            const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
            title.innerText = `${months[currentDate.getMonth()]} ${day}, ${currentDate.getFullYear()}`;

            // Filter tasks for this day
            const dayTasks = tasks.filter(t => t.date === day);
            const dayFollowups = followups.filter(f => f.date === day);

            if (dayTasks.length === 0 && dayFollowups.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-5 opacity-50">
                        <i class="fa-regular fa-calendar-xmark fa-3x mb-3"></i>
                        <h5>No Events</h5>
                        <p class="small">Enjoy your free time.</p>
                    </div>`;
                return;
            }

            let html = '';
            // Tasks
            dayTasks.forEach(task => {
                html += `
                <div class="timeline-item">
                    <div class="time-col">${formatTime(task.dateObj)}</div>
                    <div class="marker-col"></div>
                    <div class="content-col" onclick="openTaskDetail('${task._id}')">
                        <h6 class="mb-1 fw-bold">${task.title}</h6>
                        <div class="small text-muted">${task.description || ''}</div>
                        <span class="badge bg-light text-dark border">${task.type}</span>
                        ${task.customerCustId ? `<div class='small mt-1'>Linked: <a href="customers.html?search=${task.customerCustId}" class="text-gold text-decoration-none">${customerMap[task.customerCustId] || 'Customer'} (${task.customerCustId})</a></div>` : ''}
                    </div>
                </div>`;
            });
            // Followups
            dayFollowups.forEach(fu => {
                html += `
                <div class="timeline-item">
                    <div class="time-col">${formatTime(fu.followUpDateObj)}</div>
                    <div class="marker-col" style="border-color: var(--gold);"></div>
                    <div class="content-col">
                        <h6 class="mb-1 fw-bold">${fu.title}</h6>
                        <div class="small text-muted">Follow-up â€¢ <a href="customers.html?search=${fu.customerCustId}" class="text-gold text-decoration-none">${fu.customerName} (${fu.customerCustId})</a></div>
                        <span class="badge bg-warning text-dark">Follow-Up</span>
                    </div>
                </div>`;
            });

            container.innerHTML = html;

            // Animate Items In
            gsap.from(".timeline-item", { x: 20, opacity: 0, duration: 0.4, stagger: 0.1 });
        }

        // --- ADD TASK (VISUAL ONLY) ---
        async function handleAddTask(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            // Combine date + time into Date object
            const date = new Date(`${data.date}T${data.time || '09:00'}:00`);
            const payload = {
                title: data.title,
                type: data.type,
                date: date.toISOString(),
                description: data.description || '',
                customerCustId: data.customerCustId || undefined
            };
            try {
                const res = await fetch(`${API_BASE}/tasks`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const json = await res.json();
                if(!json.success){ alert(json.message || 'Failed to create task'); return; }
                // Refresh data
                await loadData();
                renderCalendar();
                renderAgenda(selectedDate.getDate());
                const modal = bootstrap.Modal.getInstance(document.getElementById('addTaskModal'));
                modal.hide();
                form.reset();
            } catch(err){
                alert('Network error creating task');
            }
        }

        function formatTime(d){
            if(!(d instanceof Date)) return '';
            return d.toLocaleTimeString('en-IN',{ hour:'2-digit', minute:'2-digit' });
        }

        function openTaskDetail(id){
            const task = tasks.find(t => t._id === id);
            if(!task) return;
            alert(`${task.title}\n\n${task.description || 'No description'}\nType: ${task.type}`);
        }

    </script>
</body>
</html>